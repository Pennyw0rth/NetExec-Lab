---
# Barbhack 2025 specific configuration playbook
# This handles all the special setup for the Pirates lab

- name: Configure JOLLYROGER (Web Server with NTLMv1)
  hosts: srv01
  gather_facts: no
  tasks:
    - name: Enable NTLMv1 on JOLLYROGER
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
        name: LmCompatibilityLevel
        data: 1
        type: dword

    - name: Create Caddy directory
      win_file:
        path: C:\Caddy
        state: directory

    - name: Create Websites directory
      win_file:
        path: C:\Websites\mywebsite
        state: directory

    - name: Copy Imprimante website to srv01
      win_copy:
        src: ../ad/BARBHACK/files/srv01/Imprimante/
        dest: C:\Websites\mywebsite\

    - name: Create TREASOR_HUNT directory
      win_file:
        path: C:\TREASOR_HUNT
        state: directory

    - name: Create Flag directory on JOLLYROGER
      win_file:
        path: C:\Flag
        state: directory

    - name: Copy flag to JOLLYROGER
      win_copy:
        src: ../ad/BARBHACK/files/srv01/flag.txt
        dest: C:\Flag\flag.txt

    - name: Copy treasure flag to share
      win_copy:
        src: ../ad/BARBHACK/files/srv01/treasor_flag.txt
        dest: C:\TREASOR_HUNT\flag.txt

    - name: Create setup directory
      win_file:
        path: C:\setup
        state: directory

- name: Configure QUEENREV (MSSQL Server)
  hosts: srv02
  gather_facts: no
  tasks:
    - name: Switch MSSQL service to NT SERVICE account (removes domain account)
      ansible.windows.win_shell: |
        $svc = (Get-Service | Where-Object { {% raw %}$_{% endraw %}.Name -like 'MSSQL{% raw %}${% endraw %}*' }).Name
        Stop-Service -Name $svc -Force
        Start-Sleep -Seconds 2
        sc.exe config $svc obj= "NT SERVICE\$svc"
        Start-Sleep -Seconds 2
        Start-Service -Name $svc
      args:
        executable: powershell
      ignore_errors: yes

    - name: Disable outgoing NTLM on QUEENREV (RestrictSendingNTLMTraffic)
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0
        name: RestrictSendingNTLMTraffic
        data: 2
        type: dword

    - name: Set LmCompatibilityLevel to 5 on QUEENREV
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
        name: LmCompatibilityLevel
        data: 5
        type: dword

    - name: Create ISLAND2 directory
      win_file:
        path: C:\ISLAND2
        state: directory

    - name: Create SMB share ISLAND2
      win_share:
        name: ISLAND2
        description: Island 2 Share
        path: C:\ISLAND2
        list: yes
        full: Administrators
      ignore_errors: yes

    - name: Grant ironhook access to ISLAND2 share
      ansible.windows.win_shell: |
        Grant-SmbShareAccess -AccessRight Full -Name ISLAND2 -AccountName "PIRATES\ironhook" -Force

    - name: Set NTFS permissions on ISLAND2 for ironhook
      ansible.windows.win_shell: |
        icacls "C:\ISLAND2" /grant "PIRATES\ironhook:(OI)(CI)F"

    - name: Create Flag directory on QUEENREV
      win_file:
        path: C:\Flag
        state: directory

- name: Generate gMSA blob on DC
  hosts: dc01
  gather_facts: no
  tasks:
    - name: Generate shipping.txt content on DC
      ansible.windows.win_shell: |
        $header = "Just found this on the back of the ship, is this sensitive information ?`r`n`r`n"
        $gmsa = Get-ADServiceAccount -Identity "gMSA-shipping" -Properties *,msDS-ManagedPassword
        $gmsaOutput = $gmsa | Out-String
        $content = $header + $gmsaOutput
        Set-Content -Path "C:\shipping.txt" -Value $content

    - name: Fetch shipping.txt from DC
      fetch:
        src: C:\shipping.txt
        dest: /tmp/shipping.txt
        flat: yes

- name: Copy gMSA blob to QUEENREV
  hosts: srv02
  gather_facts: no
  tasks:
    - name: Copy shipping.txt to ISLAND2 share
      win_copy:
        src: /tmp/shipping.txt
        dest: C:\ISLAND2\shipping.txt

    - name: Copy flag to QUEENREV
      win_copy:
        src: ../ad/BARBHACK/files/srv02/flag.txt
        dest: C:\Flag\flag.txt.txt

    - name: Copy db.sql to QUEENREV
      win_copy:
        src: ../ad/BARBHACK/scripts/db.sql
        dest: C:\setup\db.sql

    - name: Create SECRET_GOLD database and island table
      ansible.windows.win_shell: |
        SqlCmd -E -i C:\setup\db.sql
      ignore_errors: yes

- name: Configure FLYINGDUTCHMAN (NTDS Backup Server)
  hosts: srv03
  gather_facts: no
  tasks:
    - name: Disable outgoing NTLM on FLYINGDUTCHMAN (RestrictSendingNTLMTraffic)
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0
        name: RestrictSendingNTLMTraffic
        data: 2
        type: dword

    - name: Set LmCompatibilityLevel to 5 on FLYINGDUTCHMAN
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
        name: LmCompatibilityLevel
        data: 5
        type: dword

    - name: Create BACKUP directory structure
      win_file:
        path: "{{ item }}"
        state: directory
      loop:
        - C:\BACKUP
        - C:\Flag

    - name: Copy NTDS.zip backup to FLYINGDUTCHMAN
      win_copy:
        src: ../ad/BARBHACK/files/srv03/NTDS.zip
        dest: C:\BACKUP\NTDS.zip

    - name: Copy flag to FLYINGDUTCHMAN
      win_copy:
        src: ../ad/BARBHACK/files/srv03/flag.txt
        dest: C:\Flag\flag.txt.txt

- name: Configure BLACKPEARL (Domain Controller)
  hosts: dc01
  gather_facts: no
  tasks:
    - name: Disable outgoing NTLM on BLACKPEARL (RestrictSendingNTLMTraffic)
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0
        name: RestrictSendingNTLMTraffic
        data: 2
        type: dword

    - name: Set LmCompatibilityLevel to 5 on BLACKPEARL
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
        name: LmCompatibilityLevel
        data: 5
        type: dword

    - name: Set Machine Account Quota to 0
      win_shell: |
        Import-Module ActiveDirectory
        Set-ADDomain -Identity pirates.brb -Replace @{"ms-DS-MachineAccountQuota"="0"}
      ignore_errors: yes

    - name: Set flag in flint's description
      win_shell: |
        Import-Module ActiveDirectory
        Set-ADUser -Identity "flint" -Description "brb{88e7af3d7bf9ab21f9d6faa5cf644b76}"
      ignore_errors: yes

    - name: Configure Constrained Delegation (QUEENREV -> FLYINGDUTCHMAN)
      win_shell: |
        Import-Module ActiveDirectory
        $SourceAccount = Get-ADComputer -Identity "QUEENREV"
        $TargetAccount = Get-ADComputer -Identity "FLYINGDUTCHMAN"
        $TargetServiceSPN = "host/$($TargetAccount.DNSHostName)"
        Set-ADComputer -Identity $SourceAccount.DistinguishedName -Add @{'msDS-AllowedToDelegateTo'=$TargetServiceSPN}
        Set-ADComputer -Identity $SourceAccount.DistinguishedName -TrustedForDelegation $false
      ignore_errors: yes

# Remove LocalAccountTokenFilterPolicy on all servers to enforce UAC remote restrictions
# This makes the lab more realistic - only RID 500 admin can use PsExec/wmiexec
- name: Enforce UAC remote restrictions (remove LocalAccountTokenFilterPolicy)
  hosts: all
  gather_facts: no
  tasks:
    - name: Remove LocalAccountTokenFilterPolicy registry key
      win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
        name: LocalAccountTokenFilterPolicy
        state: absent
